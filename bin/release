#!/bin/sh
# bin/release <build-dir>
set -o errexit    # always exit on error

(
    cat $BUILD_DIR/.heroku-private-build.lst|while read repo_url ; do
        buildpack_code=$(echo ${repo_url}|md5sum|tr -d ' -')
        buildpack_name=__buildpack_${buildpack_code}
        buildpack_path=${BUILD_DIR}/$buildpack_name

        if [ ! -f ${buildpack_path}/bin/release ]; then
            continue
        fi
       
        echo "Calling 'release' for buildpack: $repo_url"
        ${buildpack_path}/bin/release $BUILD_DIR &>/dev/null
        res=$?

        if [ $res -ne 0 ] ; then
            exit $res
        fi      
    done
) || exit 1
