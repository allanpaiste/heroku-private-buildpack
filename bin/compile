#!/usr/bin/env bash
echo in comile script
####### Configure environment

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o posix      # more strict failures in subshells
#set -x          # enable debugging

# Configure directories
bp_dir=$(cd $(dirname $0); cd ..; pwd)
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

echo build user is `whoami`
ls -lrta ~

sh scripts/add-sshkey.sh $ENV_DIR

(
    cd $BUILD_DIR

    cat $BUILD_DIR/.heroku-private-build.lst|while read repo_url ; do
        buildpack_code=echo ${repo_url}|md5sum|tr -d ' -'
        buildpack_name=__buildpack_${buildpack_code}
        buildpack_path=${BUILD_DIR}/$buildpack_name

        echo Pulling $repo_url
        git clone $repo_url ${buildpack_name}

        if [ -f ${buildpack_path}/bin/compile ]; then
            echo "Calling buildpack compile script"
            ${buildpack_path}/bin/compile  "$BUILD_DIR" "$CACHE_DIR" "$ENV_DIR"
            exit $?
        else
            echo "No compile file in app"
            exit 1
        fi
    done
)

